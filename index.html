<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Timer</title>
  <style>
    :root {
      --bg-color: #000000;
      --text-color-default: #ffffff;
      --text-color-paused: #666666; /* Gray for paused state */
      --text-color-bell1: #ffff00; /* Yellow */
      --text-color-bell2: #ff8c00; /* DarkOrange */
      --text-color-bell3: #ff0000; /* Red */
      --control-bg: rgba(50, 50, 50, 0.8);
    }

    body {
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      color: var(--text-color-default);
      font-family: 'Helvetica Neue', Arial, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      transition: color 0.3s ease;
    }

    /* Timer Display */
    #timer-display {
      font-size: 25vw;
      font-weight: bold;
      /* Use sans-serif monospace fonts for a more formal look (Menlo, Consolas, etc.) */
      font-family: 'Menlo', 'Consolas', 'Monaco', 'Liberation Mono', 'Lucida Console', monospace;
      font-variant-numeric: tabular-nums;
      line-height: 1;
      cursor: default;
      user-select: none;
    }

    /* Controls Overlay */
    #controls-container {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: var(--control-bg);
      padding: 10px 0;
      display: flex;
      justify-content: center;
      gap: 15px;
      transform: translateY(90%);
      transition: transform 0.3s;
      opacity: 0.3;
    }

    #controls-container:hover,
    #controls-container.active {
      transform: translateY(0);
      opacity: 1;
    }

    button {
      font-size: 1.2rem;
      padding: 10px 20px;
      cursor: pointer;
      background: #444;
      color: #fff;
      border: 1px solid #666;
      border-radius: 4px;
    }

    button:hover {
      background: #666;
    }

    button:active {
      background: #888;
    }

    /* Settings Modal */
    #settings-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      justify-content: center;
      align-items: center;
      z-index: 100;
    }

    .settings-content {
      background: #222;
      padding: 30px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      color: #fff;
    }

    .settings-group {
      margin-bottom: 15px;
      display: flex;
      flex-direction: column;
    }

    .settings-group label {
      margin-bottom: 5px;
      font-size: 0.9rem;
      color: #ccc;
    }
    
    .time-input-group {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .time-input-group input {
      width: 80px;
      padding: 8px;
      font-size: 1rem;
      background: #333;
      border: 1px solid #555;
      color: #fff;
      text-align: right;
    }

    .time-input-group span {
      margin-right: 10px;
    }

    select {
      padding: 8px;
      font-size: 1rem;
      background: #333;
      border: 1px solid #555;
      color: #fff;
    }

    .close-btn {
      background: #d32f2f;
      border-color: #b71c1c;
      width: 100%;
      margin-top: 20px;
    }
    
    .hint {
      font-size: 0.8rem;
      color: #aaa;
      margin-top: 5px;
    }

    /* Color States */
    /* Note: !important is used to ensure paused state overrides bell colors */
    body.state-paused { color: var(--text-color-paused) !important; }
    
    body.state-bell1 { color: var(--text-color-bell1); }
    body.state-bell2 { color: var(--text-color-bell2); }
    body.state-bell3 { color: var(--text-color-bell3); }

  </style>
</head>
<body>

  <div id="timer-display">00:00</div>

  <!-- Controls -->
  <div id="controls-container">
    <button id="btn-start">スタート</button>
    <button id="btn-pause">一時停止</button>
    <button id="btn-reset">リセット</button>
    <button id="btn-settings">設定</button>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal">
    <div class="settings-content">
      <h2>設定</h2>
      
      <div class="settings-group">
        <label>モード</label>
        <select id="input-mode">
          <option value="up">カウントアップ</option>
          <option value="down">カウントダウン</option>
        </select>
        <div class="hint">※カウントダウンの開始時間は、各鈴の中で最も遅い時間に自動設定されます。</div>
      </div>

      <div class="settings-group">
        <label>第1鈴 (黄色)</label>
        <div class="time-input-group">
          <input type="number" id="input-bell1-min" value="10" min="0"> <span>分</span>
          <input type="number" id="input-bell1-sec" value="0" min="0" max="59"> <span>秒</span>
        </div>
      </div>

      <div class="settings-group">
        <label>第2鈴 (橙色)</label>
        <div class="time-input-group">
          <input type="number" id="input-bell2-min" value="15" min="0"> <span>分</span>
          <input type="number" id="input-bell2-sec" value="0" min="0" max="59"> <span>秒</span>
        </div>
      </div>

      <div class="settings-group">
        <label>第3鈴 (赤色)</label>
        <div class="time-input-group">
          <input type="number" id="input-bell3-min" value="20" min="0"> <span>分</span>
          <input type="number" id="input-bell3-sec" value="0" min="0" max="59"> <span>秒</span>
        </div>
      </div>

      <div class="settings-group">
        <button id="btn-test-sound">音テスト (1回)</button>
      </div>

      <button class="close-btn" id="btn-close-settings">設定終了</button>
    </div>
  </div>

  <script>
    class PresentationTimer {
      constructor() {
        // Config (internal values are in seconds)
        this.config = {
          mode: 'up',
          bell1Sec: 600,  // 10 min
          bell2Sec: 900,  // 15 min
          bell3Sec: 1200  // 20 min
        };

        // State
        this.startTime = 0;
        this.elapsedTime = 0; // ms
        this.isRunning = false;
        this.animationFrameId = null;
        this.lastBellState = 0; // 0, 1, 2, 3
        this.audioCtx = null;

        // Elements
        this.elTimer = document.getElementById('timer-display');
        this.elBody = document.body;
        this.modal = document.getElementById('settings-modal');
        
        this.init();
      }

      init() {
        this.loadUrlParams();
        this.bindEvents();
        this.updateDisplay(0);
        this.applyConfigToInputs();
        
        // Initial visual state: Paused (Gray)
        this.elBody.classList.add('state-paused');
      }

      loadUrlParams() {
        const params = new URLSearchParams(window.location.search);
        if (params.has('mode')) this.config.mode = params.get('mode');
        
        const parseParam = (key, defaultSec) => {
            if (params.has(key + 's')) {
                return parseInt(params.get(key + 's'), 10);
            }
            if (params.has(key)) {
                const val = params.get(key);
                if (val.includes(':')) {
                    const parts = val.split(':');
                    const m = parseInt(parts[0], 10) || 0;
                    const s = parseInt(parts[1], 10) || 0;
                    return (m * 60) + s;
                }
                return parseFloat(val) * 60;
            }
            return defaultSec;
        };

        this.config.bell1Sec = parseParam('b1', this.config.bell1Sec);
        this.config.bell2Sec = parseParam('b2', this.config.bell2Sec);
        this.config.bell3Sec = parseParam('b3', this.config.bell3Sec);
      }

      bindEvents() {
        document.getElementById('btn-start').addEventListener('click', () => this.start());
        document.getElementById('btn-pause').addEventListener('click', () => this.pause());
        document.getElementById('btn-reset').addEventListener('click', () => this.reset());
        
        document.getElementById('btn-settings').addEventListener('click', () => {
          this.modal.style.display = 'flex';
          this.applyConfigToInputs();
        });
        document.getElementById('btn-close-settings').addEventListener('click', () => {
          this.saveInputsToConfig();
          this.modal.style.display = 'none';
          this.updateDisplay(this.elapsedTime);
        });
        document.getElementById('btn-test-sound').addEventListener('click', () => {
          this.initAudioContext();
          this.playChime(1);
        });

        let hideTimeout;
        const controls = document.getElementById('controls-container');
        const showControls = () => {
          controls.classList.add('active');
          clearTimeout(hideTimeout);
          hideTimeout = setTimeout(() => controls.classList.remove('active'), 3000);
        };
        window.addEventListener('mousemove', showControls);
        window.addEventListener('touchstart', showControls);
      }

      initAudioContext() {
        if (!this.audioCtx) {
          const AudioContext = window.AudioContext || window.webkitAudioContext;
          this.audioCtx = new AudioContext();
        }
        if (this.audioCtx.state === 'suspended') {
          this.audioCtx.resume();
        }
      }

      start() {
        if (this.isRunning) return;
        this.initAudioContext();
        // Correct delta timing pattern: no drift over long runs
        this.startTime = Date.now() - this.elapsedTime;
        this.isRunning = true;
        // Remove paused state (gray) to reveal current bell color
        this.elBody.classList.remove('state-paused');
        this.loop();
      }

      pause() {
        this.isRunning = false;
        // Add paused state (gray)
        this.elBody.classList.add('state-paused');
        cancelAnimationFrame(this.animationFrameId);
      }

      reset() {
        this.pause();
        this.elapsedTime = 0;
        this.lastBellState = 0;
        this.updateDisplay(0);
        this.setBellState(0); // Reset bell color logic
        // Ensure paused state is active
        this.elBody.classList.add('state-paused');
      }

      loop() {
        if (!this.isRunning) return;
        // Calculate based on system clock difference
        this.elapsedTime = Date.now() - this.startTime;
        this.updateDisplay(this.elapsedTime);
        this.checkBells(this.elapsedTime);
        this.animationFrameId = requestAnimationFrame(() => this.loop());
      }

      updateDisplay(ms) {
        let totalSeconds;

        if (this.config.mode === 'down') {
          // Limit is automatically the max of the 3 bell times
          const maxSec = Math.max(this.config.bell1Sec, this.config.bell2Sec, this.config.bell3Sec);
          let remainingMs = (maxSec * 1000) - ms;

          // Stop counting at 0 (No negative values)
          if (remainingMs < 0) remainingMs = 0;

          // Use Math.ceil for countdown
          totalSeconds = Math.ceil(remainingMs / 1000);
        } else {
          // Count up
          totalSeconds = Math.floor(ms / 1000);
        }
        
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;

        const strMin = String(minutes).padStart(2, '0');
        const strSec = String(seconds).padStart(2, '0');

        this.elTimer.textContent = `${strMin}:${strSec}`;
      }

      checkBells(elapsedMs) {
        const elapsedSec = elapsedMs / 1000;
        let currentState = 0;

        if (elapsedSec >= this.config.bell3Sec) {
          currentState = 3;
        } else if (elapsedSec >= this.config.bell2Sec) {
          currentState = 2;
        } else if (elapsedSec >= this.config.bell1Sec) {
          currentState = 1;
        }

        if (currentState > this.lastBellState) {
          this.playChime(currentState);
          this.lastBellState = currentState;
        }
        
        this.setBellState(currentState);
      }

      setBellState(state) {
        // Remove old bell states
        this.elBody.classList.remove('state-bell1', 'state-bell2', 'state-bell3');
        // Apply new bell state (will be visible only if not paused)
        if (state === 1) this.elBody.classList.add('state-bell1');
        if (state === 2) this.elBody.classList.add('state-bell2');
        if (state === 3) this.elBody.classList.add('state-bell3');
      }

      playChime(count) {
        if (!this.audioCtx) return;

        const now = this.audioCtx.currentTime;
        // Interval shortened to 0.4s for multiple bells
        const interval = 0.4;

        for (let i = 0; i < count; i++) {
          const startTime = now + (i * interval);
          this.playTone(startTime);
        }
      }

      playTone(startTime) {
        const fundamental = 6600; 
        const duration = 2.5;

        const createOsc = (ratio, gainVal, decayTime) => {
          const osc = this.audioCtx.createOscillator();
          const gain = this.audioCtx.createGain();

          osc.connect(gain);
          gain.connect(this.audioCtx.destination);

          osc.type = 'sine';
          osc.frequency.value = fundamental * ratio;

          gain.gain.setValueAtTime(0, startTime);
          gain.gain.linearRampToValueAtTime(gainVal, startTime + 0.005);
          gain.gain.exponentialRampToValueAtTime(0.001, startTime + decayTime);

          osc.start(startTime);
          osc.stop(startTime + decayTime);
        };

        createOsc(1.0, 0.6, duration);
        createOsc(0.58, 0.2, duration * 0.7); 
        createOsc(2.1, 0.15, duration * 0.6);
        createOsc(3.4, 0.05, duration * 0.4);
        createOsc(4.8, 0.05, 0.3);
      }
      
      applyConfigToInputs() {
        document.getElementById('input-mode').value = this.config.mode;
        this.setMmSsInputs('bell1', this.config.bell1Sec);
        this.setMmSsInputs('bell2', this.config.bell2Sec);
        this.setMmSsInputs('bell3', this.config.bell3Sec);
      }

      setMmSsInputs(idPrefix, totalSeconds) {
        const m = Math.floor(totalSeconds / 60);
        const s = Math.floor(totalSeconds % 60);
        document.getElementById(`input-${idPrefix}-min`).value = m;
        document.getElementById(`input-${idPrefix}-sec`).value = s;
      }

      saveInputsToConfig() {
        this.config.mode = document.getElementById('input-mode').value;
        this.config.bell1Sec = this.getSecondsFromInput('bell1');
        this.config.bell2Sec = this.getSecondsFromInput('bell2');
        this.config.bell3Sec = this.getSecondsFromInput('bell3');
        this.checkBells(this.elapsedTime);
      }

      getSecondsFromInput(idPrefix) {
        const m = parseInt(document.getElementById(`input-${idPrefix}-min`).value) || 0;
        const s = parseInt(document.getElementById(`input-${idPrefix}-sec`).value) || 0;
        return (m * 60) + s;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      new PresentationTimer();
    });
  </script>
</body>
</html>
